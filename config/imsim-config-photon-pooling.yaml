# This imSim config file performs almost the same function as the base
# imsim-config.yaml and can be used as a template for other input configs.
# The only difference is that it overrides the image and stamp types in order
# to use the photon pooling pipeline.

modules:
    - imsim
template: imsim-config

# Photon pooling requires the following two changes to the base
# imsim-config.yaml, which otherwise performs the rest of the
# configuration.

# LSST_PhotonPoolingImages firstly determine how all objects are to be drawn,
# then batch the FFT and photon objects separately. FFT objects are drawn
# one-by-one first. Each photon batch contains all of the brighter photon
# objects, at 1/nbatch their total flux. Faint objects are drawn in one go after
# being randomly inserted into the photon batches at full flux. Once the photons
# from all the objects in a batch have been generated by the LSST_Photons stamp,
# the image pools and draws them.

# LSST_Photons is a special stamp type that must be used with
# LSST_PhotonPoolingImage. FFT objects are drawn as normal. Photon shooting
# objects are however drawn with a special NullSensor which does nothing,
# leaving photon stamps to be returned with the photons only.

image.type: LSST_PhotonPoolingImage
stamp.type: LSST_Photons

# Disable the regular GalSim truth output and instead use the photon pooling truth
# which accumulates the flux from the photon objects across all batches. (Note though
# that this measures the flux that was incident rather than the flux that was actually 
# added to the image.)
output.truth: ""
output.photon_pooling_truth:
    dir: output
    file_name:
        type: FormattedStr
        format : centroid_%08d-%1d-%s-%s-det%03d.txt.gz
        items:
            - { type: OpsimData, field: observationId }
            - { type: OpsimData, field: snap }
            - $band
            - $det_name
            - "@output.det_num"
    columns:
        object_id: "@object_id"
        ra: $sky_pos.ra.deg
        dec: $sky_pos.dec.deg
        x: $image_pos.x
        y: $image_pos.y

        # Note: these next 4 will only work if using the LSST_Photons stamp type.
        nominal_flux: "@nominal_flux"  # The nominal "expectation value" flux.
        phot_flux: "@phot_flux"  # The realized flux for photon shooting.
        fft_flux: "@fft_flux"  # If FFT rendering, then the flux used, including vignetting.
        incident_flux: "@incident_flux"  # The sum of the fluxes of all photons from the object.