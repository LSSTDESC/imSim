modules:
  - imsim

eval_variables:
  sband: g
  fexptime: 30.0
  scamera: "@output.camera"
  dcamera_info: {
    template: "$os.path.join(imsim.meta_data.data_dir, camera + '_info.yaml')"
  }
  arotTelPos: 0.0 deg
  fRubinHeight: 5.425 # height of TMA az/el axes intersection above azimuth ring
  fM1Height: 3.53 # height of M1 above azimuth ring when zenith pointing
  fCBPHeight: 12.135  # height of CBP az/el axes intersection above azimuth ring
  fRubinCBPRadialDist: 12.4  # radial distance from CBP origin to Rubin origin
  aRubinEl: $np.arctan2(CBPHeight-RubinHeight, RubinCBPRadialDist) * galsim.radians
  aCBPEl: $-RubinEl
  aRubinAz: 0.0 deg
  aCBPAz: $RubinAz + 180*galsim.degrees
  # The following perturb Rubin and CBP off of their nominal positions in which their
  # boresights are aligned with the opposing telescope's az/el axis intersection.
  # Note that the azimuth axis is parallel to zenith.  So equal motions in az and el
  # do not produce symmetric results in mutual alignment.
  aDeltaRubinAz: 15 deg
  aDeltaRubinEl: 0.0 deg
  aDeltaCBPAz: 15 deg
  aDeltaCBPEl: 0.0 deg
  # aDeltaRubinAz: 0.0 deg
  # aDeltaRubinEl: 12.5 deg
  # aDeltaCBPAz: 0.0 deg
  # aDeltaCBPEl: -12.5 deg

input:
  telescope:
    -
      file_name:
        type: FormattedStr
        format: $camera_info['telescope_format']
        items:
          - $band
      rotTelPos: $rotTelPos
      camera: $camera_info['camera_name']
      perturbations:
        -
          RubinComCam:
            shift: $[0, 0, M1Height-RubinHeight]  # Move origin from M1 to Az/El intersection
            rotZ: $-RubinAz
            rot:
              axis: x
              angle: $90*galsim.degrees - RubinEl
              coordSys: global
        -  # Elevation adjustment
          RubinComCam:
            rot:
              axis: x
              angle: $DeltaRubinEl
              coordSys: global  # Center of rotation is global origin
              frame: local  # Rotate parallel to local x axis
        -  # Azimuth adjustment
          RubinComCam:
            rot:
              axis: z
              angle: $-DeltaRubinAz
              coordSys: global  # Center of rotation is global origin
              frame: global  # Rotate parallel to global z axis
    -
      file_name: CBP.yaml
      camera: "CBP"
      perturbations:
        -
          CBP:
            rotX: 180 deg
            shift: $[0, -RubinCBPRadialDist, -(CBPHeight-RubinHeight)]
            rotZ: 180 deg
        -
          CBP:
            rotX: $90*galsim.degrees + CBPEl
            rot:
              axis: z
              angle: $-CBPAz
              coordSys: global  # rot Center is Rubin; e.g. rotate the dome with CBP attached
              frame: global
        -  # Elevation adjustment
          CBP:
            rotX: $-DeltaCBPEl  # shortcut when frame and coordSys are both local
        -  # Azimuth adjustment
          CBP:
            rot:
              axis: z
              angle: $-DeltaCBPAz
              coordSys: local  # Center of rotation is local CBP origin
              frame: global  # Rotate parallel to global z axis

image:
  type: LSST_Image
  det_name: $det_name
  nobjects: 144
  wcs:
    type: cbp
    det_name: $det_name
    camera: $camera
  # image_pos:
  #   - $700, 700
  #   - $3500, 3500
  world_pos:
    - $-3700.060620756547, -3372.7061105722596
    - $-3386.5640155189135, -3064.7526673132875
    - $-3073.0674102812804, -3680.6595538312313
    - $-2759.5708050436474, -2756.799224054316
    - $-2446.074199806014, -3372.7061105722596
    - $-2132.5775945683804, -3680.6595538312313
    - $-1819.0809893307471, -3064.7526673132875
    - $-1505.584384093114, -2756.799224054316
    - $-3700.060620756547, -2448.845780795344
    - $-3386.5640155189135, -2140.892337536372
    - $-3073.0674102812804, -1524.9854510184286
    - $-2759.5708050436474, -1832.9388942774003
    - $-2446.074199806014, -2448.845780795344
    - $-2132.5775945683804, -1524.9854510184286
    - $-1819.0809893307471, -2140.892337536372
    - $-1505.584384093114, -1832.9388942774003
    - $-1097.854025218235, -3064.7526673132875
    - $-784.3574199806014, -2756.799224054316
    - $-470.8608147429681, -3372.7061105722596
    - $-157.3642095053347, -3680.6595538312313
    - $156.13239573229865, -2756.799224054316
    - $469.629000969932, -3372.7061105722596
    - $783.1256062075653, -3680.6595538312313
    - $1096.6222114451984, -3064.7526673132875
    - $-1097.854025218235, -2140.892337536372
    - $-784.3574199806014, -1524.9854510184286
    - $-470.8608147429681, -1832.9388942774003
    - $-157.3642095053347, -2448.845780795344
    - $156.13239573229865, -1524.9854510184286
    - $469.629000969932, -1832.9388942774003
    - $783.1256062075653, -2448.845780795344
    - $1096.6222114451984, -2140.892337536372
    - $1504.3525703200773, -3372.7061105722596
    - $1817.8491755577109, -3064.7526673132875
    - $2131.3457807953446, -3680.6595538312313
    - $2444.8423860329776, -2756.799224054316
    - $2758.3389912706107, -3372.7061105722596
    - $3071.835596508244, -3680.6595538312313
    - $3385.3322017458777, -3064.7526673132875
    - $3698.8288069835103, -2756.799224054316
    - $1504.3525703200773, -2448.845780795344
    - $1817.8491755577109, -2140.892337536372
    - $2131.3457807953446, -1524.9854510184286
    - $2444.8423860329776, -1832.9388942774003
    - $2758.3389912706107, -2448.845780795344
    - $3071.835596508244, -1524.9854510184286
    - $3385.3322017458777, -2140.892337536372
    - $3698.8288069835103, -1832.9388942774003
    - $-3700.060620756547, -462.54607177497564
    - $-3386.5640155189135, -154.59262851600374
    - $-3073.0674102812804, -770.4995150339475
    - $-2759.5708050436474, -1078.4529582929194
    - $-2446.074199806014, -154.59262851600374
    - $-2132.5775945683804, -770.4995150339475
    - $-1819.0809893307471, -1078.4529582929194
    - $-1505.584384093114, -462.54607177497564
    - $-3700.060620756547, 461.31425800194
    - $-3386.5640155189135, 1077.2211445198836
    - $-3073.0674102812804, 769.2677012609118
    - $-2759.5708050436474, 153.3608147429681
    - $-2446.074199806014, 1077.2211445198836
    - $-2132.5775945683804, 769.2677012609118
    - $-1819.0809893307471, 153.3608147429681
    - $-1505.584384093114, 461.31425800194
    - $-1097.854025218235, -770.4995150339475
    - $-784.3574199806014, -462.54607177497564
    - $-470.8608147429681, -1078.4529582929194
    - $-157.3642095053347, -154.59262851600374
    - $156.13239573229865, -770.4995150339475
    - $469.629000969932, -1078.4529582929194
    - $783.1256062075653, -462.54607177497564
    - $1096.6222114451984, -154.59262851600374
    - $-1097.854025218235, 153.3608147429681
    - $-784.3574199806014, 461.31425800194
    - $-470.8608147429681, 1077.2211445198836
    - $-157.3642095053347, 769.2677012609118
    - $156.13239573229865, 153.3608147429681
    - $469.629000969932, 1077.2211445198836
    - $783.1256062075653, 461.31425800194
    - $1096.6222114451984, 769.2677012609118
    - $1504.3525703200773, -462.54607177497564
    - $1817.8491755577109, -154.59262851600374
    - $2131.3457807953446, -770.4995150339475
    - $2444.8423860329776, -1078.4529582929194
    - $2758.3389912706107, -154.59262851600374
    - $3071.835596508244, -770.4995150339475
    - $3385.3322017458777, -1078.4529582929194
    - $3698.8288069835103, -462.54607177497564
    - $1504.3525703200773, 461.31425800194
    - $1817.8491755577109, 1077.2211445198836
    - $2131.3457807953446, 769.2677012609118
    - $2444.8423860329776, 153.3608147429681
    - $2758.3389912706107, 1077.2211445198836
    - $3071.835596508244, 769.2677012609118
    - $3385.3322017458777, 153.3608147429681
    - $3698.8288069835103, 461.31425800194
    - $-3700.060620756547, 1831.7070805043647
    - $-3386.5640155189135, 2139.6605237633366
    - $-3073.0674102812804, 1523.7536372453928
    - $-2759.5708050436474, 2447.6139670223083
    - $-2446.074199806014, 1831.7070805043647
    - $-2132.5775945683804, 1523.7536372453928
    - $-1819.0809893307471, 2139.6605237633366
    - $-1505.584384093114, 2447.6139670223083
    - $-3700.060620756547, 2755.56741028128
    - $-3386.5640155189135, 3063.520853540252
    - $-3073.0674102812804, 3679.427740058196
    - $-2759.5708050436474, 3371.474296799224
    - $-2446.074199806014, 2755.56741028128
    - $-2132.5775945683804, 3679.427740058196
    - $-1819.0809893307471, 3063.520853540252
    - $-1505.584384093114, 3371.474296799224
    - $-1097.854025218235, 2139.6605237633366
    - $-784.3574199806014, 2447.6139670223083
    - $-470.8608147429681, 1831.7070805043647
    - $-157.3642095053347, 1523.7536372453928
    - $156.13239573229865, 2447.6139670223083
    - $469.629000969932, 1831.7070805043647
    - $783.1256062075653, 1523.7536372453928
    - $1096.6222114451984, 2139.6605237633366
    - $-1097.854025218235, 3063.520853540252
    - $-784.3574199806014, 3679.427740058196
    - $-470.8608147429681, 3371.474296799224
    - $-157.3642095053347, 2755.56741028128
    - $156.13239573229865, 3679.427740058196
    - $469.629000969932, 3371.474296799224
    - $783.1256062075653, 2755.56741028128
    - $1096.6222114451984, 3063.520853540252
    - $1504.3525703200773, 1831.7070805043647
    - $1817.8491755577109, 2139.6605237633366
    - $2131.3457807953446, 1523.7536372453928
    - $2444.8423860329776, 2447.6139670223083
    - $2758.3389912706107, 1831.7070805043647
    - $3071.835596508244, 1523.7536372453928
    - $3385.3322017458777, 2139.6605237633366
    - $3698.8288069835103, 2447.6139670223083
    - $1504.3525703200773, 2755.56741028128
    - $1817.8491755577109, 3063.520853540252
    - $2131.3457807953446, 3679.427740058196
    - $2444.8423860329776, 3371.474296799224
    - $2758.3389912706107, 2755.56741028128
    - $3071.835596508244, 3679.427740058196
    - $3385.3322017458777, 3063.520853540252
    - $3698.8288069835103, 3371.474296799224
  bandpass:
    type: RubinBandpass
    band: $band

stamp:
  type: LSST_Silicon
  band: $band
  photon_ops:
    -
      type: CBPRubinOptics
      camera: $camera
    -
      type: FocusDepth
      depth:
        type: Eval
        str: depth_dict[band]
        ddepth_dict: {'u':0, 'g':0, 'r':0, 'i':0, 'z':0, 'y':-0.6}
    -
      type: Refraction
      index_ratio: 3.9

gal:
  type: TopHat
  radius: $150.0/2  # micron
  flux: 1.0e6
  sed: $galsim.sed.EmissionLine(wavelength=500.0).withFluxDensity(1.0, 500.0)

output:
  type: LSST_CCD
  nproc: 9    # Change this to work on multiple CCDs at once.
  nfiles: 9   # Default is all 189 CCDs.  Set to 1 while testing.
  # camera: LsstCam
  camera: LsstComCamSim
  exptime: $exptime
  cosmic_ray_rate: 0.2
  det_num:
    type: Sequence
    nitems: $camera_info['ndets']
  dir: fits
  file_name: $f"eimage_20240705-0-{band}-{det_name}-det{det_num}.fits"
